/*
 * RGB Display Drawing Functions
 * 
 * Software-based drawing primitives operating on the framebuffer
 */

#include <string.h>
#include <stdlib.h>
#include "rgb_display.h"

// External framebuffer access
extern uint16_t* rgb_display_get_framebuffer(void);

// Simple 8x16 bitmap font (ASCII 32-127)
// Each character is 8 pixels wide and 16 pixels tall
// Data is stored as 16 bytes per character (1 byte per row)
static const uint8_t font8x16[] = {
    // Space (32)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // ! (33)
    0x00, 0x00, 0x18, 0x3C, 0x3C, 0x3C, 0x18, 0x18,
    0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
    // " (34)
    0x00, 0x63, 0x63, 0x63, 0x22, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // # (35)
    0x00, 0x00, 0x00, 0x36, 0x36, 0x7F, 0x36, 0x36,
    0x36, 0x7F, 0x36, 0x36, 0x00, 0x00, 0x00, 0x00,
    // $ (36)
    0x0C, 0x0C, 0x3E, 0x63, 0x61, 0x60, 0x3E, 0x03,
    0x03, 0x43, 0x63, 0x3E, 0x0C, 0x0C, 0x00, 0x00,
    // % (37)
    0x00, 0x00, 0x00, 0x00, 0x61, 0x63, 0x06, 0x0C,
    0x18, 0x30, 0x63, 0x43, 0x00, 0x00, 0x00, 0x00,
    // & (38)
    0x00, 0x00, 0x1C, 0x36, 0x36, 0x1C, 0x3B, 0x6E,
    0x66, 0x66, 0x3B, 0x00, 0x00, 0x00, 0x00, 0x00,
    // ' (39)
    0x00, 0x30, 0x30, 0x30, 0x60, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // ( (40)
    0x00, 0x00, 0x0C, 0x18, 0x18, 0x30, 0x30, 0x30,
    0x30, 0x18, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00,
    // ) (41)
    0x00, 0x00, 0x18, 0x0C, 0x0C, 0x06, 0x06, 0x06,
    0x06, 0x0C, 0x0C, 0x18, 0x00, 0x00, 0x00, 0x00,
    // * (42)
    0x00, 0x00, 0x00, 0x00, 0x42, 0x66, 0x3C, 0xFF,
    0x3C, 0x66, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00,
    // + (43)
    0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x7E,
    0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
    // , (44)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x18, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00,
    // - (45)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // . (46)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
    // / (47)
    0x00, 0x00, 0x01, 0x03, 0x06, 0x0C, 0x18, 0x30,
    0x60, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
    // 0 (48)
    0x00, 0x00, 0x3E, 0x63, 0x63, 0x63, 0x6B, 0x6B,
    0x63, 0x63, 0x63, 0x3E, 0x00, 0x00, 0x00, 0x00,
    // 1 (49)
    0x00, 0x00, 0x0C, 0x1C, 0x3C, 0x0C, 0x0C, 0x0C,
    0x0C, 0x0C, 0x0C, 0x3F, 0x00, 0x00, 0x00, 0x00,
    // 2 (50)
    0x00, 0x00, 0x3E, 0x63, 0x03, 0x06, 0x0C, 0x18,
    0x30, 0x60, 0x63, 0x7F, 0x00, 0x00, 0x00, 0x00,
    // 3 (51)
    0x00, 0x00, 0x3E, 0x63, 0x03, 0x03, 0x1E, 0x03,
    0x03, 0x03, 0x63, 0x3E, 0x00, 0x00, 0x00, 0x00,
    // 4 (52)
    0x00, 0x00, 0x06, 0x0E, 0x1E, 0x36, 0x66, 0x7F,
    0x06, 0x06, 0x06, 0x0F, 0x00, 0x00, 0x00, 0x00,
    // 5 (53)
    0x00, 0x00, 0x7F, 0x60, 0x60, 0x60, 0x7E, 0x03,
    0x03, 0x63, 0x73, 0x3E, 0x00, 0x00, 0x00, 0x00,
    // 6 (54)
    0x00, 0x00, 0x1C, 0x30, 0x60, 0x60, 0x7E, 0x63,
    0x63, 0x63, 0x63, 0x3E, 0x00, 0x00, 0x00, 0x00,
    // 7 (55)
    0x00, 0x00, 0x7F, 0x63, 0x03, 0x06, 0x06, 0x0C,
    0x0C, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
    // 8 (56)
    0x00, 0x00, 0x3E, 0x63, 0x63, 0x63, 0x3E, 0x63,
    0x63, 0x63, 0x63, 0x3E, 0x00, 0x00, 0x00, 0x00,
    // 9 (57)
    0x00, 0x00, 0x3E, 0x63, 0x63, 0x63, 0x3F, 0x03,
    0x03, 0x03, 0x06, 0x3C, 0x00, 0x00, 0x00, 0x00,
    // : (58)
    0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
    0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
    // ; (59)
    0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
    0x00, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00,
    // < (60)
    0x00, 0x00, 0x00, 0x06, 0x0C, 0x18, 0x30, 0x60,
    0x30, 0x18, 0x0C, 0x06, 0x00, 0x00, 0x00, 0x00,
    // = (61)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00,
    0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // > (62)
    0x00, 0x00, 0x00, 0x60, 0x30, 0x18, 0x0C, 0x06,
    0x0C, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00,
    // ? (63)
    0x00, 0x00, 0x3E, 0x63, 0x63, 0x06, 0x0C, 0x0C,
    0x0C, 0x00, 0x0C, 0x0C, 0x00, 0x00, 0x00, 0x00,
    // @ (64)
    0x00, 0x00, 0x3E, 0x63, 0x63, 0x6F, 0x6B, 0x6B,
    0x6E, 0x60, 0x60, 0x3E, 0x00, 0x00, 0x00, 0x00,
    // A (65)
    0x00, 0x00, 0x08, 0x1C, 0x36, 0x63, 0x63, 0x7F,
    0x63, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00,
    // B (66)
    0x00, 0x00, 0x7E, 0x33, 0x33, 0x33, 0x3E, 0x33,
    0x33, 0x33, 0x33, 0x7E, 0x00, 0x00, 0x00, 0x00,
    // C (67)
    0x00, 0x00, 0x1E, 0x33, 0x61, 0x60, 0x60, 0x60,
    0x60, 0x61, 0x33, 0x1E, 0x00, 0x00, 0x00, 0x00,
    // D (68)
    0x00, 0x00, 0x7C, 0x36, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x36, 0x7C, 0x00, 0x00, 0x00, 0x00,
    // E (69)
    0x00, 0x00, 0x7F, 0x33, 0x31, 0x34, 0x3C, 0x34,
    0x30, 0x31, 0x33, 0x7F, 0x00, 0x00, 0x00, 0x00,
    // F (70)
    0x00, 0x00, 0x7F, 0x33, 0x31, 0x34, 0x3C, 0x34,
    0x30, 0x30, 0x30, 0x78, 0x00, 0x00, 0x00, 0x00,
    // G (71)
    0x00, 0x00, 0x1E, 0x33, 0x61, 0x60, 0x60, 0x6F,
    0x63, 0x63, 0x37, 0x1D, 0x00, 0x00, 0x00, 0x00,
    // H (72)
    0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x7F, 0x63,
    0x63, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00,
    // I (73)
    0x00, 0x00, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18,
    0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00,
    // J (74)
    0x00, 0x00, 0x0F, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x06, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00,
    // K (75)
    0x00, 0x00, 0x73, 0x33, 0x36, 0x36, 0x3C, 0x36,
    0x36, 0x33, 0x33, 0x73, 0x00, 0x00, 0x00, 0x00,
    // L (76)
    0x00, 0x00, 0x78, 0x30, 0x30, 0x30, 0x30, 0x30,
    0x30, 0x31, 0x33, 0x7F, 0x00, 0x00, 0x00, 0x00,
    // M (77)
    0x00, 0x00, 0x63, 0x77, 0x7F, 0x6B, 0x63, 0x63,
    0x63, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00,
    // N (78)
    0x00, 0x00, 0x63, 0x63, 0x73, 0x7B, 0x7F, 0x6F,
    0x67, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00,
    // O (79)
    0x00, 0x00, 0x1C, 0x36, 0x63, 0x63, 0x63, 0x63,
    0x63, 0x63, 0x36, 0x1C, 0x00, 0x00, 0x00, 0x00,
    // P (80)
    0x00, 0x00, 0x7E, 0x33, 0x33, 0x33, 0x3E, 0x30,
    0x30, 0x30, 0x30, 0x78, 0x00, 0x00, 0x00, 0x00,
    // Q (81)
    0x00, 0x00, 0x3E, 0x63, 0x63, 0x63, 0x63, 0x63,
    0x63, 0x6B, 0x6F, 0x3E, 0x06, 0x07, 0x00, 0x00,
    // R (82)
    0x00, 0x00, 0x7E, 0x33, 0x33, 0x33, 0x3E, 0x36,
    0x36, 0x33, 0x33, 0x73, 0x00, 0x00, 0x00, 0x00,
    // S (83)
    0x00, 0x00, 0x3E, 0x63, 0x63, 0x30, 0x1C, 0x06,
    0x03, 0x63, 0x63, 0x3E, 0x00, 0x00, 0x00, 0x00,
    // T (84)
    0x00, 0x00, 0xFF, 0xDB, 0x99, 0x18, 0x18, 0x18,
    0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00,
    // U (85)
    0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63,
    0x63, 0x63, 0x63, 0x3E, 0x00, 0x00, 0x00, 0x00,
    // V (86)
    0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63,
    0x63, 0x36, 0x1C, 0x08, 0x00, 0x00, 0x00, 0x00,
    // W (87)
    0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x63, 0x6B,
    0x6B, 0x7F, 0x36, 0x36, 0x00, 0x00, 0x00, 0x00,
    // X (88)
    0x00, 0x00, 0xC3, 0xC3, 0x66, 0x3C, 0x18, 0x18,
    0x3C, 0x66, 0xC3, 0xC3, 0x00, 0x00, 0x00, 0x00,
    // Y (89)
    0x00, 0x00, 0xC3, 0xC3, 0xC3, 0x66, 0x3C, 0x18,
    0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00,
    // Z (90)
    0x00, 0x00, 0x7F, 0x63, 0x43, 0x06, 0x0C, 0x18,
    0x30, 0x61, 0x63, 0x7F, 0x00, 0x00, 0x00, 0x00,
    // [ (91)
    0x00, 0x00, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30,
    0x30, 0x30, 0x30, 0x3C, 0x00, 0x00, 0x00, 0x00,
    // \ (92)
    0x00, 0x00, 0x80, 0xC0, 0x60, 0x30, 0x18, 0x0C,
    0x06, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    // ] (93)
    0x00, 0x00, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
    0x0C, 0x0C, 0x0C, 0x3C, 0x00, 0x00, 0x00, 0x00,
    // ^ (94)
    0x08, 0x1C, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // _ (95)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00,
    // ` (96)
    0x18, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // a (97)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x46, 0x06,
    0x3E, 0x66, 0x66, 0x3B, 0x00, 0x00, 0x00, 0x00,
    // b (98)
    0x00, 0x00, 0x70, 0x30, 0x30, 0x3C, 0x36, 0x33,
    0x33, 0x33, 0x33, 0x6E, 0x00, 0x00, 0x00, 0x00,
    // c (99)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x63, 0x60,
    0x60, 0x60, 0x63, 0x3E, 0x00, 0x00, 0x00, 0x00,
    // d (100)
    0x00, 0x00, 0x0E, 0x06, 0x06, 0x1E, 0x36, 0x66,
    0x66, 0x66, 0x66, 0x3B, 0x00, 0x00, 0x00, 0x00,
    // e (101)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x63, 0x7F,
    0x60, 0x60, 0x63, 0x3E, 0x00, 0x00, 0x00, 0x00,
    // f (102)
    0x00, 0x00, 0x1C, 0x36, 0x32, 0x30, 0x7C, 0x30,
    0x30, 0x30, 0x30, 0x78, 0x00, 0x00, 0x00, 0x00,
    // g (103)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3B, 0x66, 0x66,
    0x66, 0x66, 0x3E, 0x06, 0x66, 0x3C, 0x00, 0x00,
    // h (104)
    0x00, 0x00, 0x70, 0x30, 0x30, 0x36, 0x3B, 0x33,
    0x33, 0x33, 0x33, 0x73, 0x00, 0x00, 0x00, 0x00,
    // i (105)
    0x00, 0x00, 0x0C, 0x0C, 0x00, 0x1C, 0x0C, 0x0C,
    0x0C, 0x0C, 0x0C, 0x1E, 0x00, 0x00, 0x00, 0x00,
    // j (106)
    0x00, 0x00, 0x06, 0x06, 0x00, 0x0E, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x66, 0x66, 0x3C, 0x00, 0x00,
    // k (107)
    0x00, 0x00, 0x70, 0x30, 0x30, 0x33, 0x33, 0x36,
    0x3C, 0x36, 0x33, 0x73, 0x00, 0x00, 0x00, 0x00,
    // l (108)
    0x00, 0x00, 0x1C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
    0x0C, 0x0C, 0x0C, 0x1E, 0x00, 0x00, 0x00, 0x00,
    // m (109)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x6E, 0x7F, 0x6B,
    0x6B, 0x6B, 0x6B, 0x6B, 0x00, 0x00, 0x00, 0x00,
    // n (110)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x6E, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x33, 0x00, 0x00, 0x00, 0x00,
    // o (111)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x63, 0x63,
    0x63, 0x63, 0x63, 0x3E, 0x00, 0x00, 0x00, 0x00,
    // p (112)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x6E, 0x33, 0x33,
    0x33, 0x33, 0x3E, 0x30, 0x30, 0x78, 0x00, 0x00,
    // q (113)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3B, 0x66, 0x66,
    0x66, 0x66, 0x3E, 0x06, 0x06, 0x0F, 0x00, 0x00,
    // r (114)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x6E, 0x3B, 0x33,
    0x30, 0x30, 0x30, 0x78, 0x00, 0x00, 0x00, 0x00,
    // s (115)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x63, 0x38,
    0x0E, 0x03, 0x63, 0x3E, 0x00, 0x00, 0x00, 0x00,
    // t (116)
    0x00, 0x00, 0x08, 0x18, 0x18, 0x7E, 0x18, 0x18,
    0x18, 0x18, 0x1B, 0x0E, 0x00, 0x00, 0x00, 0x00,
    // u (117)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66,
    0x66, 0x66, 0x66, 0x3B, 0x00, 0x00, 0x00, 0x00,
    // v (118)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x63,
    0x63, 0x36, 0x1C, 0x08, 0x00, 0x00, 0x00, 0x00,
    // w (119)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x6B,
    0x6B, 0x6B, 0x7F, 0x36, 0x00, 0x00, 0x00, 0x00,
    // x (120)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x36, 0x1C,
    0x1C, 0x1C, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00,
    // y (121)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x63,
    0x63, 0x63, 0x3F, 0x03, 0x06, 0x3C, 0x00, 0x00,
    // z (122)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x66, 0x0C,
    0x18, 0x30, 0x63, 0x7F, 0x00, 0x00, 0x00, 0x00,
    // { (123)
    0x00, 0x00, 0x0E, 0x18, 0x18, 0x18, 0x70, 0x18,
    0x18, 0x18, 0x18, 0x0E, 0x00, 0x00, 0x00, 0x00,
    // | (124)
    0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00,
    0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00,
    // } (125)
    0x00, 0x00, 0x70, 0x18, 0x18, 0x18, 0x0E, 0x18,
    0x18, 0x18, 0x18, 0x70, 0x00, 0x00, 0x00, 0x00,
    // ~ (126)
    0x00, 0x00, 0x3B, 0x6E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

#define FONT_WIDTH  8
#define FONT_HEIGHT 16

// Helper: Clamp coordinates to screen bounds
static inline int clamp(int val, int min_val, int max_val)
{
    if (val < min_val) return min_val;
    if (val > max_val) return max_val;
    return val;
}

static inline int min_int(int a, int b) { return a < b ? a : b; }
static inline int max_int(int a, int b) { return a > b ? a : b; }
static inline void swap_int(int *a, int *b) { int t = *a; *a = *b; *b = t; }

void rgb_display_clear(uint16_t color)
{
    uint16_t *fb = rgb_display_get_framebuffer();
    if (!fb) return;
    
    int total_pixels = RGB_DISPLAY_WIDTH * RGB_DISPLAY_HEIGHT;
    for (int i = 0; i < total_pixels; i++) {
        fb[i] = color;
    }
}

void rgb_display_draw_pixel(int x, int y, uint16_t color)
{
    if (x < 0 || x >= RGB_DISPLAY_WIDTH || y < 0 || y >= RGB_DISPLAY_HEIGHT) return;
    
    uint16_t *fb = rgb_display_get_framebuffer();
    if (fb) {
        fb[y * RGB_DISPLAY_WIDTH + x] = color;
    }
}

uint16_t rgb_display_read_pixel(int x, int y)
{
    if (x < 0 || x >= RGB_DISPLAY_WIDTH || y < 0 || y >= RGB_DISPLAY_HEIGHT) return 0;
    
    uint16_t *fb = rgb_display_get_framebuffer();
    if (fb) {
        return fb[y * RGB_DISPLAY_WIDTH + x];
    }
    return 0;
}

void rgb_display_draw_hline(int x, int y, int w, uint16_t color)
{
    if (y < 0 || y >= RGB_DISPLAY_HEIGHT || w <= 0) return;
    
    int x_start = clamp(x, 0, RGB_DISPLAY_WIDTH - 1);
    int x_end = clamp(x + w - 1, 0, RGB_DISPLAY_WIDTH - 1);
    
    uint16_t *fb = rgb_display_get_framebuffer();
    if (!fb) return;
    
    uint16_t *row = &fb[y * RGB_DISPLAY_WIDTH + x_start];
    int len = x_end - x_start + 1;
    for (int i = 0; i < len; i++) {
        row[i] = color;
    }
}

void rgb_display_draw_vline(int x, int y, int h, uint16_t color)
{
    if (x < 0 || x >= RGB_DISPLAY_WIDTH || h <= 0) return;
    
    int y_start = clamp(y, 0, RGB_DISPLAY_HEIGHT - 1);
    int y_end = clamp(y + h - 1, 0, RGB_DISPLAY_HEIGHT - 1);
    
    uint16_t *fb = rgb_display_get_framebuffer();
    if (!fb) return;
    
    for (int cy = y_start; cy <= y_end; cy++) {
        fb[cy * RGB_DISPLAY_WIDTH + x] = color;
    }
}

void rgb_display_draw_line(int x0, int y0, int x1, int y1, uint16_t color)
{
    // Bresenham's line algorithm
    int dx = abs(x1 - x0);
    int dy = abs(y1 - y0);
    int sx = (x0 < x1) ? 1 : -1;
    int sy = (y0 < y1) ? 1 : -1;
    int err = dx - dy;
    
    while (1) {
        rgb_display_draw_pixel(x0, y0, color);
        
        if (x0 == x1 && y0 == y1) break;
        
        int e2 = 2 * err;
        if (e2 > -dy) {
            err -= dy;
            x0 += sx;
        }
        if (e2 < dx) {
            err += dx;
            y0 += sy;
        }
    }
}

void rgb_display_draw_rect(int x, int y, int w, int h, uint16_t color, bool filled)
{
    if (filled) {
        for (int cy = y; cy < y + h; cy++) {
            rgb_display_draw_hline(x, cy, w, color);
        }
    } else {
        rgb_display_draw_hline(x, y, w, color);           // Top
        rgb_display_draw_hline(x, y + h - 1, w, color);   // Bottom
        rgb_display_draw_vline(x, y, h, color);           // Left
        rgb_display_draw_vline(x + w - 1, y, h, color);   // Right
    }
}

void rgb_display_draw_circle(int cx, int cy, int r, uint16_t color, bool filled)
{
    // Midpoint circle algorithm
    int x = 0;
    int y = r;
    int d = 3 - 2 * r;
    
    while (x <= y) {
        if (filled) {
            rgb_display_draw_hline(cx - x, cy + y, 2 * x + 1, color);
            rgb_display_draw_hline(cx - x, cy - y, 2 * x + 1, color);
            rgb_display_draw_hline(cx - y, cy + x, 2 * y + 1, color);
            rgb_display_draw_hline(cx - y, cy - x, 2 * y + 1, color);
        } else {
            rgb_display_draw_pixel(cx + x, cy + y, color);
            rgb_display_draw_pixel(cx - x, cy + y, color);
            rgb_display_draw_pixel(cx + x, cy - y, color);
            rgb_display_draw_pixel(cx - x, cy - y, color);
            rgb_display_draw_pixel(cx + y, cy + x, color);
            rgb_display_draw_pixel(cx - y, cy + x, color);
            rgb_display_draw_pixel(cx + y, cy - x, color);
            rgb_display_draw_pixel(cx - y, cy - x, color);
        }
        
        if (d < 0) {
            d = d + 4 * x + 6;
        } else {
            d = d + 4 * (x - y) + 10;
            y--;
        }
        x++;
    }
}

void rgb_display_draw_triangle(int x0, int y0, int x1, int y1, int x2, int y2, 
                                uint16_t color, bool filled)
{
    if (!filled) {
        rgb_display_draw_line(x0, y0, x1, y1, color);
        rgb_display_draw_line(x1, y1, x2, y2, color);
        rgb_display_draw_line(x2, y2, x0, y0, color);
        return;
    }
    
    // Sort vertices by Y coordinate
    if (y0 > y1) { swap_int(&x0, &x1); swap_int(&y0, &y1); }
    if (y1 > y2) { swap_int(&x1, &x2); swap_int(&y1, &y2); }
    if (y0 > y1) { swap_int(&x0, &x1); swap_int(&y0, &y1); }
    
    int total_height = y2 - y0;
    if (total_height == 0) {
        rgb_display_draw_hline(min_int(min_int(x0, x1), x2), y0, 
                                max_int(max_int(x0, x1), x2) - min_int(min_int(x0, x1), x2) + 1, color);
        return;
    }
    
    for (int i = 0; i <= total_height; i++) {
        int second_half = (i > y1 - y0) || (y1 == y0);
        int segment_height = second_half ? (y2 - y1) : (y1 - y0);
        if (segment_height == 0) continue;
        
        float alpha = (float)i / total_height;
        float beta = second_half ? 
            (float)(i - (y1 - y0)) / segment_height : 
            (float)i / segment_height;
        
        int ax = x0 + (x2 - x0) * alpha;
        int bx = second_half ? x1 + (x2 - x1) * beta : x0 + (x1 - x0) * beta;
        
        if (ax > bx) swap_int(&ax, &bx);
        rgb_display_draw_hline(ax, y0 + i, bx - ax + 1, color);
    }
}

static void draw_char(int x, int y, char c, uint16_t fg_color, uint16_t bg_color, bool use_bg)
{
    if (c < 32 || c > 126) c = '?';
    
    int char_index = c - 32;
    const uint8_t *char_data = &font8x16[char_index * FONT_HEIGHT];
    
    for (int row = 0; row < FONT_HEIGHT; row++) {
        uint8_t row_data = char_data[row];
        for (int col = 0; col < FONT_WIDTH; col++) {
            int px = x + col;
            int py = y + row;
            
            if (px >= 0 && px < RGB_DISPLAY_WIDTH && py >= 0 && py < RGB_DISPLAY_HEIGHT) {
                if (row_data & (0x80 >> col)) {
                    rgb_display_draw_pixel(px, py, fg_color);
                } else if (use_bg) {
                    rgb_display_draw_pixel(px, py, bg_color);
                }
            }
        }
    }
}

void rgb_display_draw_text(int x, int y, const char *text, uint16_t color)
{
    if (!text) return;
    
    int cur_x = x;
    while (*text) {
        if (*text == '\n') {
            y += FONT_HEIGHT;
            cur_x = x;
        } else if (*text == '\r') {
            cur_x = x;
        } else {
            draw_char(cur_x, y, *text, color, 0, false);
            cur_x += FONT_WIDTH;
        }
        text++;
    }
}

void rgb_display_draw_text_bg(int x, int y, const char *text, 
                               uint16_t fg_color, uint16_t bg_color)
{
    if (!text) return;
    
    int cur_x = x;
    while (*text) {
        if (*text == '\n') {
            y += FONT_HEIGHT;
            cur_x = x;
        } else if (*text == '\r') {
            cur_x = x;
        } else {
            draw_char(cur_x, y, *text, fg_color, bg_color, true);
            cur_x += FONT_WIDTH;
        }
        text++;
    }
}

void rgb_display_draw_image(int x, int y, int w, int h, const uint16_t *data)
{
    if (!data) return;
    
    uint16_t *fb = rgb_display_get_framebuffer();
    if (!fb) return;
    
    for (int row = 0; row < h; row++) {
        int py = y + row;
        if (py < 0 || py >= RGB_DISPLAY_HEIGHT) continue;
        
        for (int col = 0; col < w; col++) {
            int px = x + col;
            if (px < 0 || px >= RGB_DISPLAY_WIDTH) continue;
            
            fb[py * RGB_DISPLAY_WIDTH + px] = data[row * w + col];
        }
    }
}
